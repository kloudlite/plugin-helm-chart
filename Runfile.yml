tasks:
  new:api:
    desc: create a new api

    requires:
      - sh: test -f "PROJECT"

    env:
      version:
        required: true

      kind: 
        required: true

    cmd:
      - |
        kubebuilder create api --version ${version} --kind ${kind} --resource --controller

  manifests:
    cmd:
      - make manifests
      - make generate

  dev:
    env:
      HELM_JOB_IMAGE: "ghcr.io/kloudlite/kloudlite/operator/workers/helm-job-runner:v1.1.4"
    cmd:
      - make run

  go:build:
    env:
      CGO_ENABLED: 0
      GOARCH:
        default:
          sh: "go env GOARCH"
    cmd:
      - go build -ldflags='-s -w' -o ./bin/plugin-helm-controller-$GOARCH ./cmd

  build:
    env:
      HELM_JOB_IMAGE: "ghcr.io/kloudlite/kloudlite/operator/workers/helm-job-runner:v1.1.4"
      image:
        required: true
    cmd:
      - run: go:build
        env:
          GOARCH: amd64
      - run: go:build
        env:
          GOARCH: arm64
      - docker buildx build -t "$image" --output=type=image,compression=zstd,force-compression=true,compression-level=12,push=true --platform linux/amd64,linux/arm64 --build-arg BINARY=./bin/plugin-helm-controller .


